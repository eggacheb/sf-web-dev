<!DOCTYPE html>
<html lang="zh">

<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffe6f0">
    <meta name="description" content="一个基于云崽的智能对话应用">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="SFChat">
    <link rel="manifest" href="public/manifest.json">
    
    <!-- 网站图标配置 -->
    <link rel="icon" type="image/png" sizes="32x32" href="public/images/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="public/images/icon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="public/images/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="public/images/icon-512x512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="public/images/icon-180x180.png">
    <link rel="apple-touch-icon-precomposed" sizes="180x180" href="public/images/icon-180x180.png">
    <link rel="shortcut icon" href="public/images/favicon.ico">
    
    <link rel="preload" href="public/fonts/LXGWWenKai-Regular-9375313a.ttf" as="font" />
    <script src="public/js/marked.min.js"></script>
    <link rel="stylesheet" href="public/css/github.min.css">
    <script src="public/js/highlight.min.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script src="public/js/mathjax/tex-mml-chtml.js" async></script>
    <style>
        @font-face {
            font-family: "LXGWWenKai";
            src: url('public/fonts/LXGWWenKai-Regular-9375313a.ttf') format('truetype');
        }

        @font-face {
            font-family: "HYWenHei";
            src: url('public/fonts/HYWH-65W.ttf') format('truetype');
        }

        @font-face {
            font-family: "SpaceMono";
            src: url('public/fonts/SpaceMono-Regular.ttf') format('truetype');
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: #ffe6f0;
            font-family: "LXGWWenKai", "HYWenHei", "Microsoft YaHei", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-weight: 500;
            height: 100vh;
            overflow: hidden;
            box-sizing: border-box;
        }

        .chat-container {
            width: 100%;
            max-width: 1200px;
            height: calc(100vh - 40px);
            margin: 0 auto;
            position: relative;
            z-index: 1;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px 90px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow-y: auto;
            overflow-x: hidden;
            box-sizing: border-box;
            border-radius: 20px;
            border: 1px solid rgba(255, 182, 193, 0.2);
        }

        .input-container {
            position: fixed;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 60px);
            max-width: 1200px;
            background: transparent;
            padding: 0;
            z-index: 100;
            box-shadow: none;
        }

        .input-wrapper {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 25px;
            padding: 8px 12px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
            align-items: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 182, 193, 0.2);
            position: relative;
        }

        .image-preview-container {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            padding: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .image-preview-item {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 182, 193, 0.3);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-image {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #ff69b4;
            font-size: 14px;
            line-height: 1;
            border: none;
            padding: 0;
        }

        .image-preview-item .remove-image:hover {
            background: #ff69b4;
            color: white;
        }

        .button-group {
            display: flex;
            gap: 8px;
        }

        .action-button {
            width: 35px;
            height: 35px;
            min-width: 35px;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            background: white;
            color: #ff69b4;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 1px 4px rgba(255, 182, 193, 0.2);
            flex-shrink: 0;
        }

        .action-button:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(255, 105, 180, 0.2);
        }

        .action-button svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .action-button.active {
            background: linear-gradient(135deg, #ffb6c1, #ff69b4);
            color: white;
        }

        #history-panel {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        #history-panel h3 {
            color: #ff69b4;
            margin: 0 0 20px 0;
            font-size: 1.2em;
        }

        .history-item {
            padding: 15px;
            background: #fff5f7;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 1px solid rgba(255, 182, 193, 0.2);
        }

        .history-item:hover {
            background: #ffe6f0;
            transform: translateX(-5px);
        }

        .history-time {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .history-delete {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #ff69b4;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .history-item:hover .history-delete {
            opacity: 1;
        }

        .history-delete:hover {
            background: #ff1493;
        }

        #settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        #settings-modal.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            visibility: visible;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #message-input {
            flex: 1;
            min-height: 18px;
            height: 28px;
            padding: 6px 16px 8px;
            border-radius: 23px;
            border: 2px solid rgba(255, 182, 193, 0.5);
            resize: none;
            font-family: inherit;
            font-size: 17px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            line-height: 18px;
            overflow-y: hidden;
            box-sizing: border-box;
            vertical-align: top;
            min-width: 200px;
        }

        #message-input:focus {
            outline: none;
            border-color: #ff69b4;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.1);
        }
        #send-button {
            width: 45px;
            height: 45px;
            border: none;
            background: transparent;
            color: #ff69b4;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        #send-button::before {
            content: '';
            display: block;
            width: 10px;
            height: 10px;
            border-top: 2px solid currentColor;
            border-right: 2px solid currentColor;
            transform: rotate(45deg);
            margin-left: -4px;
        }

        .mode-toggle {
            width: 35px;
            height: 35px;
            min-width: 35px;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            background: white;
            font-family: inherit;
            font-size: 12px;
            color: #ff69b4;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            position: relative;
            overflow: hidden;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 1px 4px rgba(255, 182, 193, 0.2);
            flex-shrink: 0;
        }

        .mode-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(255, 105, 180, 0.2);
        }

        .mode-toggle.ss-mode {
            background: linear-gradient(135deg, #ffb6c1, #ff69b4);
            color: white;
        }

        .mode-toggle:not(.ss-mode) {
            background: white;
            box-shadow: 0 2px 8px rgba(255, 182, 193, 0.15);
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-start;
            position: relative;
            padding-left: 35px;
            min-height: 51px;
            animation: message-slide-up 0.3s ease-out;
            transform-origin: bottom;
        }

        @keyframes message-slide-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.right {
            flex-direction: row-reverse;
            padding-left: 0;
            padding-right: 35px;
            margin-left: auto;
        }

        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            position: absolute;
            top: 0;
        }

        .message.left .avatar {
            left: -25px;
        }

        .message.right .avatar {
            right: -25px;
        }

        .message-content {
            max-width: calc(100% - 10px);
            min-width: 50px;
            padding: 0px 16px;
            border-radius: 20px 20px 20px 20px;
            position: relative;
            animation: pop-in 0.3s ease-out;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            width: fit-content;
            word-wrap: break-word;
            overflow-wrap: break-word;
            height: auto;
            overflow: visible;
            margin-top: 3px;
        }

        .left .message-content {
            background-color: #ffffff;
            border-top-left-radius: 4px;
            border-left: 3px solid #ffb6c1;
            box-shadow: 1px 1px 8px rgba(255, 182, 193, 0.15);
        }

        .left .message-content::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 15px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 12px 8px 0;
            border-color: transparent #ffffff transparent transparent;
            filter: drop-shadow(-3px 0px 2px rgba(255, 182, 193, 0.1));
        }

        .right .message-content {
            background-color: #e3f2fd;
            border-top-right-radius: 4px;
            box-shadow: -1px 1px 8px rgba(227, 242, 253, 0.2);
        }

        .right .message-content::before {
            content: '';
            position: absolute;
            right: -12px;
            top: 15px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 0 8px 12px;
            border-color: transparent transparent transparent #e3f2fd;
        }

        @keyframes pop-in {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .markdown-content {
            font-size: 16px;
            line-height: 1.6;
            color: #000000;
            font-weight: 500 !important;
            letter-spacing: 0.3px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            height: auto;
            overflow: visible;
            font-family: "LXGWWenKai", "HYWenHei", "Microsoft YaHei", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .markdown-content * {
            font-weight: inherit;
            color: inherit;
        }

        .markdown-content p {
            margin: 12px 0;
            line-height: 1.8;
            font-weight: 500;
            color: #000000;
        }

        .markdown-content code {
            font-family: "SpaceMono", "Consolas", monospace;
            background-color: #f8f8f8;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.95em;
            border: 1px solid #eee;
            color: #000000;
            font-weight: 500;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .markdown-content pre {
            background-color: #f8f8f8;
            padding: 16px;
            border-radius: 8px;
            overflow: visible;
            border: 1px solid #eee;
            margin: 15px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-width: 100%;
            color: #000000;
            font-weight: 500;
            font-family: "SpaceMono", "Consolas", monospace;
            line-height: 1.5;
        }

        .markdown-content pre code {
            font-weight: 500;
            color: #000000;
            padding: 0;
            background: none;
            border: none;
            display: block;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            font-family: "LXGWWenKai", sans-serif;
            color: #ff69b4;
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
            letter-spacing: 0.5px;
        }

        .markdown-content h1 {
            font-size: 2.2em;
        }

        .markdown-content h2 {
            font-size: 1.7em;
        }

        .markdown-content h3 {
            font-size: 1.5em;
        }

        .markdown-content h4 {
            font-size: 1.3em;
        }

        .markdown-content h5 {
            font-size: 1.2em;
        }

        .markdown-content h6 {
            font-size: 1.1em;
        }

        .markdown-content a {
            color: #ff69b4;
            text-decoration: none;
            border-bottom: 1px solid #ff69b4;
            transition: all 0.3s ease;
        }

        .markdown-content a:hover {
            color: #ff1493;
            border-bottom-color: #ff1493;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .markdown-content table {
            width: 100%;
            max-width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            overflow-x: auto;
            display: block;
        }

        .markdown-content th,
        .markdown-content td {
            padding: 12px;
            text-align: left;
            border: 1px solid #eee;
        }

        .markdown-content th {
            background: #ffb6c1;
            color: white;
            font-weight: bold;
        }

        .markdown-content tr:nth-child(even) {
            background: #fff5f7;
        }

        .markdown-content blockquote {
            margin: 10px 0;
            padding: 10px 20px;
            border-left: 4px solid #ffb6c1;
            background: #fff5f7;
            border-radius: 0 8px 8px 0;
        }

        .markdown-content ul,
        .markdown-content ol {
            padding-left: 20px;
        }

        .markdown-content li {
            margin: 5px 0;
        }

        .markdown-content hr {
            border: none;
            height: 2px;
            background: linear-gradient(to right, #ffb6c1, #ff69b4);
            margin: 20px 0;
        }

        .markdown-content input[type="checkbox"] {
            margin-right: 5px;
        }

        .markdown-content kbd {
            background-color: #f7f7f7;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2);
            color: #333;
            display: inline-block;
            font-size: 0.9em;
            padding: 2px 6px;
            margin: 0 2px;
        }

        .cute-girl {
            position: absolute;
            right: 0px;
            bottom: 10px;
            width: 150px;
            height: auto;
            z-index: 1;
            pointer-events: none;
            opacity: 0.25;
            transition: opacity 0.3s ease;
        }

        .chat-container:hover .cute-girl {
            opacity: 0.4;
        }

        /* 添加滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f5f5f5;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #ffb6c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ff69b4;
        }

        .settings-item {
            margin-bottom: 15px;
        }

        .settings-item label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }

        .settings-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .settings-button {
            background: #ff69b4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 10px;
        }

        .settings-button:hover {
            background: #ff1493;
        }

        .settings-status {
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
        }

        /* 添加消息提示样式 */
        .message-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .message-toast.show {
            opacity: 1;
        }

        /* 添加确认对话框样式 */
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            max-width: 300px;
            width: 90%;
        }

        .confirm-dialog.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .confirm-dialog .message {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            font-size: 16px;
        }

        .confirm-dialog .buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .confirm-dialog button {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .confirm-dialog .confirm-btn {
            background: #ff69b4;
            color: white;
        }

        .confirm-dialog .confirm-btn:hover {
            background: #ff1493;
        }

        .confirm-dialog .cancel-btn {
            background: #f5f5f5;
            color: #666;
        }

        .confirm-dialog .cancel-btn:hover {
            background: #e0e0e0;
        }

        /* 添加菜单样式 */
        .settings-menu {
            display: flex;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .menu-item {
            padding: 8px 16px;
            border: none;
            background: none;
            color: #666;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            background: #f0f0f0;
        }

        .menu-item.active {
            background: #ff69b4;
            color: white;
        }

        .settings-tab {
            display: none;
            padding: 20px;
        }

        .settings-tab.active {
            display: block;
        }

        /* 关于页面样式 */
        .about-content {
            color: #666;
            line-height: 1.6;
        }

        .about-content h4 {
            color: #ff69b4;
            margin-bottom: 10px;
        }

        .about-content h5 {
            color: #666;
            margin: 15px 0 5px;
        }

        .about-content ul,
        .about-content ol {
            padding-left: 20px;
            margin: 5px 0;
        }

        .about-content li {
            margin: 5px 0;
        }

        /* 工具按钮样式 */
        .tools-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            padding: 10px;
        }

        .tool-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 15px;
            border: none;
            background: #fff5f7;
            color: #ff69b4;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tool-button:hover {
            background: #ff69b4;
            color: white;
        }

        .tool-button svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .tool-button span {
            font-size: 14px;
        }

        /* 添加关闭按钮样式 */
        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border: none;
            background: none;
            cursor: pointer;
            color: #ff69b4;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-button:hover {
            background: #fff5f7;
            transform: rotate(90deg);
        }
    </style>
</head>

<body>
    <div class="chat-container">
        <!-- 聊天消息将在这里动态添加 -->
    </div>
    
    <div class="input-container">
        <div class="input-wrapper">
            <div class="image-preview-container" id="image-preview-container">
                <!-- 图片预览将在这里动态添加 -->
            </div>
            <button class="action-button" id="settings-button" title="设置">
                <svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"></path></svg>
            </button>
            <button class="mode-toggle" id="mode-toggle">SS</button>
            <textarea id="message-input" placeholder="请输入消息..."></textarea>
            <button id="send-button" aria-label="发送"></button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-overlay"></div>
    <div id="settings-modal">
        <button class="close-button" id="close-settings">×</button>
        <h3>设置</h3>
        <div class="settings-content">
            <div class="settings-menu">
                <button class="menu-item active" data-tab="connection">连接设置</button>
                <button class="menu-item" data-tab="tools">工具</button>
                <button class="menu-item" data-tab="about">关于</button>
            </div>
            <div class="settings-tab active" id="connection-tab">
                <div class="settings-item">
                    <label for="ws-ip">服务器地址:</label>
                    <input type="text" id="ws-ip" placeholder="输入服务器地址(支持域名/IPv4/IPv6)">
                </div>
                <div class="settings-item">
                    <label for="ws-port">端口号: <span style="color: #666; font-size: 0.9em;">(可选)</span></label>
                    <input type="number" id="ws-port" placeholder="留空则使用默认端口8081" min="1" max="65535">
                    <div style="font-size: 0.85em; color: #666; margin-top: 4px;">
                        提示: 如不填写端口号，将使用默认端口8081
                    </div>
                </div>
                <div class="settings-item">
                    <label for="user-qq">用户QQ:</label>
                    <input type="text" id="user-qq" placeholder="输入您的QQ号">
                </div>
                <div class="settings-item">
                    <label for="bot-qq">BOTQQ:</label>
                    <input type="text" id="bot-qq" placeholder="输入BOTQQ号">
                </div>
                <div class="settings-item">
                    <label for="ws-password">访问密码:</label>
                    <input type="password" id="ws-password" placeholder="请输入访问密码">
                </div>
                <button id="ws-connect" class="settings-button">连接</button>
                <div id="ws-status" class="settings-status"></div>
            </div>
            <div class="settings-tab" id="tools-tab">
                <div class="tools-buttons">
                    <button class="tool-button" id="upload-button">
                        <svg viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"></path></svg>
                        <span>上传图片</span>
                    </button>
                    <button class="tool-button" id="clear-button">
                        <svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"></path></svg>
                        <span>清空页面</span>
                    </button>
                </div>
            </div>
            <div class="settings-tab" id="about-tab">
                <div class="about-content">
                    <h4>SiliconFlow Plugin</h4>
                    <p>这是一个基于云崽的对话插件，支持SS和GG两种模式。</p>
                    <div class="features">
                        <h5>功能特点：</h5>
                        <ul>
                            <li>支持文本对话</li>
                            <li>支持图片识别</li>
                            <li>支持Markdown格式</li>
                            <li>支持数学公式</li>
                        </ul>
                    </div>
                    <div class="usage">
                        <h5>使用说明：</h5>
                        <ol>
                            <li>在设置中输入云崽服务器的IP和端口</li>
                            <li>在设置中输入您的QQ号和BOTQQ号,用于获取头像以及历史对话</li>
                            <li>在设置中输入访问密码,用于WebSocket服务的访问，如果sf插件的锅巴里没有相关设置，请更新sf插件</li>
                            <li>点击连接按钮建立WebSocket连接</li>
                            <li>选择对话模式(SS/GG)</li>
                            <li>开始对话！</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加消息提示和确认对话框容器 -->
    <div class="message-toast" id="message-toast"></div>
    <div class="confirm-dialog" id="confirm-dialog">
        <div class="message"></div>
        <div class="buttons">
            <button class="cancel-btn">取消</button>
            <button class="confirm-btn">确定</button>
        </div>
    </div>

    <script>
        // 获取所有按钮元素
        const settingsButton = document.getElementById('settings-button');
        const uploadButton = document.getElementById('upload-button');
        const clearButton = document.getElementById('clear-button');
        const sendButton = document.getElementById('send-button');
        const messageInput = document.getElementById('message-input');
        const settingsModal = document.getElementById('settings-modal');
        const modalOverlay = document.getElementById('modal-overlay');

        // 配置Marked选项
        marked.setOptions({
            renderer: new marked.Renderer(),
            highlight: function (code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-',
            pedantic: false,
            gfm: true,
            breaks: true,
            sanitize: false,
            smartypants: false,
            xhtml: false,
            escape: function(html) {
                return html.replace(/\\/g, '\\\\');
            }
        });

        // 模式切换逻辑
        const modeToggle = document.getElementById('mode-toggle');
        let currentMode = 'ss';
        modeToggle.classList.add('ss-mode');

        modeToggle.addEventListener('click', () => {
            currentMode = currentMode === 'ss' ? 'gg' : 'ss';
            modeToggle.textContent = currentMode.toUpperCase();
            modeToggle.classList.toggle('ss-mode');
            // 保存模式设置
            saveSettings();

            // 切换模式后重新加载历史记录
            if (wsConnected) {
                const userQQ = document.getElementById('user-qq').value.trim() || 'web_user';
                console.log('[sf插件] 切换模式,重新加载历史记录:', userQQ, currentMode);
                const msgObj = {
                    type: 'loadHistory',
                    userQQ: userQQ,
                    mode: currentMode.toLowerCase(),
                    timestamp: new Date().getTime()
                };
                wsConnection.send(JSON.stringify(msgObj));
            }
        });

        // 自动调整输入框高度的函数
        function autoResize(textarea) {
            textarea.style.height = '28px';  // 基础高度 = min-height + padding*2
            const newHeight = Math.max(28, textarea.scrollHeight);
            textarea.style.height = newHeight + 'px';
        }

        // 监听输入事件
        messageInput.addEventListener('input', function() {
            autoResize(this);
        });

        // 添加键盘事件处理
        messageInput.addEventListener('keydown', function(e) {
            // 如果是 Enter 键且没有按住 Shift 键
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // 阻止默认的换行行为
                sendButton.click(); // 触发发送按钮的点击事件
            }
            // 如果是 Shift + Enter，则允许换行
            if (e.key === 'Enter' && e.shiftKey) {
                autoResize(this);
            }
        });

        // 处理发送按钮点击
        function handleSendButtonAction() {
            sendButton.blur();
        }

        // 只保留必要的事件监听
        sendButton.addEventListener('click', handleSendButtonAction);
        sendButton.addEventListener('touchend', handleSendButtonAction);

        // 清空页面按钮处理
        clearButton.addEventListener('click', async () => {
            if (await showConfirm('确定要清空当前页面吗？')) {
                // 清空页面显示
                document.querySelector('.chat-container').innerHTML = '';
                showToast('页面已清空');
            }
        });

        // 设置按钮点击处理
        settingsButton.addEventListener('click', () => {
            settingsModal.classList.add('active');
            modalOverlay.classList.add('active');
        });

        // 关闭模态框
        modalOverlay.addEventListener('click', () => {
            settingsModal.classList.remove('active');
            modalOverlay.classList.remove('active');
        });

        // 上传图片按钮处理
        uploadButton.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Data = e.target.result;
                        addImagePreview(base64Data, file.name);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        });

        // 添加图片预览
        function addImagePreview(base64Data, fileName) {
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.dataset.base64 = base64Data; // 存储base64数据
            
            const img = document.createElement('img');
            img.src = base64Data;
            
            const removeButton = document.createElement('button');
            removeButton.className = 'remove-image';
            removeButton.innerHTML = '×';
            removeButton.onclick = () => {
                previewItem.remove();
            };
            
            previewItem.appendChild(img);
            previewItem.appendChild(removeButton);
            imagePreviewContainer.appendChild(previewItem);
        }
        
        // 发送消息处理
        sendButton.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (!message && !document.querySelector('.image-preview-item')) {
                return; // 如果没有文字且没有图片,则不发送
            }
            
            if (!wsConnected) {
                showToast('请先连接WebSocket服务器');
                return;
            }
            
            try {
                // 收集所有预览中的图片
                const images = [];
                const imagePreviewContainer = document.getElementById('image-preview-container');
                const previewItems = imagePreviewContainer.getElementsByClassName('image-preview-item');
                for (const item of previewItems) {
                    const base64Data = item.dataset.base64; // 保留完整的data URL
                    images.push(base64Data);
                }
                
                // 构造发送的消息
                let displayContent = message;
                if (images.length > 0) {
                    // 在消息末尾添加图片预览
                    images.forEach((base64, index) => {
                        displayContent += `\n![图片${index + 1}](${base64})`;
                    });
                }
                
                const msgObj = {
                    type: currentMode.toLowerCase(),
                    content: message, // 原始文本消息
                    timestamp: new Date().getTime(),
                    images: images.length > 0 ? images : undefined,
                    userQQ: document.getElementById('user-qq').value.trim() || 'web_user'
                };
                
                wsConnection.send(JSON.stringify(msgObj));
                
                // 添加消息到界面(包含图片预览)
                addMessage(displayContent, 'right', true);
                
                // 清空输入框和图片预览
                messageInput.value = '';
                imagePreviewContainer.innerHTML = '';
                autoResize(messageInput);
            } catch (error) {
                console.error('发送消息错误:', error);
                showToast('发送消息失败: ' + error.message);
            }
        });
    </script>

    <script type="text/javascript">
        // WebSocket连接状态
        let wsConnection = null;
        let wsConnected = false;
        let autoReconnectTimer = null;
        const RECONNECT_INTERVAL = 5000; // 5秒重连间隔
        
        // 添加密码验证相关代码
        let wsAuthenticated = false;
        
        // 保存设置到本地存储
        function saveSettings() {
            const settings = {
                ip: document.getElementById('ws-ip').value.trim(),
                port: document.getElementById('ws-port').value.trim(),
                mode: currentMode,
                userQQ: document.getElementById('user-qq').value.trim(),
                botQQ: document.getElementById('bot-qq').value.trim(),
                wsPassword: document.getElementById('ws-password').value.trim(),
                lastUpdate: new Date().getTime()
            };
            localStorage.setItem('sf_plugin_settings', JSON.stringify(settings));
        }

        // 从本地存储加载设置
        function loadSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('sf_plugin_settings'));
                if (settings) {
                    document.getElementById('ws-ip').value = settings.ip || '';
                    document.getElementById('ws-port').value = settings.port || '';
                    document.getElementById('user-qq').value = settings.userQQ || '';
                    document.getElementById('bot-qq').value = settings.botQQ || '';
                    document.getElementById('ws-password').value = settings.wsPassword || '';
                    
                    if (settings.mode) {
                        currentMode = settings.mode;
                        modeToggle.textContent = currentMode.toUpperCase();
                        modeToggle.classList.toggle('ss-mode', currentMode === 'ss');
                    }
                    
                    // 如果有保存的IP和端口,自动尝试连接
                    if (settings.ip && settings.port) {
                        setTimeout(() => {
                            connectWebSocket(settings.ip, settings.port, true);
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('加载设置失败:', error);
            }
        }

        // 页面加载时加载设置
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
        });

        // 连接按钮点击事件
        document.getElementById('ws-connect').addEventListener('click', () => {
            const ip = document.getElementById('ws-ip').value.trim();
            const port = document.getElementById('ws-port').value.trim();
            saveSettings();
            connectWebSocket(ip, port);
        });
        
        // 修改 addMessage 函数
        let lastUserMessageElement = null;

        function addMessage(content, position, shouldSave = true) {
            if (!content || typeof content !== 'string') {
                console.error('Invalid message content:', content);
                return;
            }

            const chatContainer = document.querySelector('.chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${position}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';

            // 获取QQ号
            const userQQ = document.getElementById('user-qq').value.trim();
            const botQQ = document.getElementById('bot-qq').value.trim();

            // 设置头像URL
            if (position === 'right' && userQQ) {
                avatar.style.backgroundImage = `url(https://q1.qlogo.cn/g?b=qq&s=0&nk=${userQQ})`;
            } else if (position === 'left' && botQQ) {
                avatar.style.backgroundImage = `url(https://q1.qlogo.cn/g?b=qq&s=0&nk=${botQQ})`;
            } else {
                // 使用默认头像
                avatar.style.backgroundImage = position === 'left' ? 
                    'url("public/images/bot-avatar.png")' : 
                    'url("public/images/user-avatar.png")';
            }
            avatar.style.backgroundSize = 'cover';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const markdownContent = document.createElement('div');
            markdownContent.className = 'markdown-content';
            
            try {
                if (content.includes('![') && content.includes('](data:image')) {
                    const processedContent = content.replace(/!\[.*?\]\((data:image\/[^)]+)\)/g, 
                        '<img src="$1" style="max-width: 300px; border-radius: 8px; margin: 5px 0;">');
                    markdownContent.innerHTML = marked.parse(processedContent);
                } else {
                    // 处理普通图片链接,添加随机参数
                    const processedContent = content.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (match, alt, url) => {
                        const separator = url.includes('?') ? '&' : '?';
                        return `![${alt}](${url}${separator}t=${Date.now()})`;
                    });
                    markdownContent.innerHTML = marked.parse(processedContent);
                }
            } catch (error) {
                console.error('Markdown parsing error:', error);
                markdownContent.textContent = content;
            }
            
            messageContent.appendChild(markdownContent);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatContainer.appendChild(messageDiv);

            // 处理消息定位
            if (position === 'right') {
                // 用户发送的消息
                lastUserMessageElement = messageDiv;
                // 平滑滚动到新消息
                setTimeout(() => {
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            } else if (position === 'left' && lastUserMessageElement) {
                // 机器人回复，滚动到上一条用户消息
                setTimeout(() => {
                    lastUserMessageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
            
            // 渲染数学公式
            if (window.MathJax) {
                try {
                    // 检查MathJax是否已完全加载
                    if (typeof MathJax.typesetPromise === 'function') {
                        MathJax.typesetPromise([markdownContent]).catch(error => {
                            console.error('MathJax error:', error);
                        });
                    } else {
                        console.log('等待MathJax加载完成...');
                        // 等待MathJax加载完成
                        const checkMathJax = setInterval(() => {
                            if (typeof MathJax.typesetPromise === 'function') {
                                clearInterval(checkMathJax);
                                MathJax.typesetPromise([markdownContent]).catch(error => {
                                    console.error('MathJax error:', error);
                                });
                            }
                        }, 100);
                        
                        // 设置超时,避免无限等待
                        setTimeout(() => {
                            clearInterval(checkMathJax);
                            console.warn('MathJax加载超时');
                        }, 5000);
                    }
                } catch (error) {
                    console.error('MathJax处理错误:', error);
                }
            }
        }

        // 添加消息提示和确认对话框功能
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('message-toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        function showConfirm(message) {
            return new Promise((resolve) => {
                const dialog = document.getElementById('confirm-dialog');
                dialog.querySelector('.message').textContent = message;
                dialog.classList.add('show');
                modalOverlay.classList.add('active');
                
                const confirmBtn = dialog.querySelector('.confirm-btn');
                const cancelBtn = dialog.querySelector('.cancel-btn');
                
                const cleanup = () => {
                    dialog.classList.remove('show');
                    modalOverlay.classList.remove('active');
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                };
                
                confirmBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };
                
                cancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
                
                modalOverlay.onclick = () => {
                    cleanup();
                    resolve(false);
                };
            });
        }

        // 添加菜单切换功能
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                // 移除所有active类
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                
                // 添加active类到当前项
                item.classList.add('active');
                document.getElementById(`${item.dataset.tab}-tab`).classList.add('active');
            });
        });

        // 监听输入变化自动保存
        document.getElementById('ws-ip').addEventListener('change', saveSettings);
        document.getElementById('ws-port').addEventListener('change', saveSettings);
        document.getElementById('user-qq').addEventListener('change', saveSettings);
        document.getElementById('bot-qq').addEventListener('change', saveSettings);
        document.getElementById('ws-password').addEventListener('change', saveSettings);

        // 关闭按钮事件
        document.getElementById('close-settings').addEventListener('click', () => {
            settingsModal.classList.remove('active');
            modalOverlay.classList.remove('active');
        });

        // 自动重连函数
        function startAutoReconnect() {
            if (autoReconnectTimer) {
                clearInterval(autoReconnectTimer);
            }
            autoReconnectTimer = setInterval(() => {
                if (!wsConnected) {
                    const ip = document.getElementById('ws-ip').value.trim();
                    const port = document.getElementById('ws-port').value.trim();
                    if (ip && port) {
                        console.log('尝试重新连接...');
                        connectWebSocket(ip, port, true);
                    }
                }
            }, RECONNECT_INTERVAL);
        }

        // WebSocket连接函数
        async function connectWebSocket(ip, port, isAutoConnect = false) {
            if (!ip) {
                if (!isAutoConnect) {
                    showToast('请输入服务器地址');
                }
                return;
            }
            
            try {
                if (wsConnection) {
                    wsConnection.close();
                }
                
                // 如果没有指定端口，使用默认端口8081
                const serverAddress = port ? `${ip}:${port}` : `${ip}:8081`;
                const proxyUrl = `wss://ws.maliya.top?url=${encodeURIComponent(`ws://${serverAddress}`)}`;
                wsConnection = new WebSocket(proxyUrl);
                
                const connectionTimeout = setTimeout(() => {
                    if (!wsConnected) {
                        wsConnection.close();
                        if (!isAutoConnect) {
                            showToast('连接超时，请检查IP和端口是否正确');
                        }
                        document.getElementById('ws-status').textContent = '未连接';
                        document.getElementById('ws-status').style.color = '#f44336';
                    }
                }, 5000);
                
                wsConnection.onopen = () => {
                    clearTimeout(connectionTimeout);
                    wsConnected = true;
                    document.getElementById('ws-status').textContent = '已连接';
                    document.getElementById('ws-status').style.color = '#4CAF50';
                    if (!isAutoConnect) {
                        showToast('连接成功！');
                        settingsModal.classList.remove('active');
                        modalOverlay.classList.remove('active');
                    }
                    startAutoReconnect();

                    // 发送密码验证
                    const password = document.getElementById('ws-password').value.trim();
                    wsConnection.send(JSON.stringify({
                        type: 'auth',
                        password: password
                    }));

                    // 连接成功后请求历史记录
                    const userQQ = document.getElementById('user-qq').value.trim() || 'web_user';
                    console.log('[sf插件] 请求加载历史记录:', userQQ, currentMode);
                    const msgObj = {
                        type: 'loadHistory',
                        userQQ: userQQ,
                        mode: currentMode.toLowerCase(),
                        timestamp: new Date().getTime()
                    };
                    wsConnection.send(JSON.stringify(msgObj));
                };
                
                wsConnection.onclose = () => {
                    console.log('[sf插件] WebSocket连接已断开');
                    wsConnected = false;
                    document.getElementById('ws-status').textContent = '未连接';
                    document.getElementById('ws-status').style.color = '#f44336';
                    if (!isAutoConnect) {
                        showToast('连接已断开');
                    }
                };
                
                wsConnection.onerror = (error) => {
                    console.error('[sf插件] WebSocket错误:', error);
                    if (!isAutoConnect) {
                        showToast('连接失败，请确保服务器已启动且IP和端口正确');
                    }
                    document.getElementById('ws-status').textContent = '未连接';
                    document.getElementById('ws-status').style.color = '#f44336';
                };
                
                wsConnection.onmessage = (event) => {
                    try {
                        const msgObj = JSON.parse(event.data);
                        if (msgObj.type === 'auth') {
                            if (msgObj.success) {
                                wsAuthenticated = true;
                                document.getElementById('ws-status').textContent = '已连接';
                                document.getElementById('ws-status').style.color = '#4CAF50';
                                showToast('连接成功！');
                                settingsModal.classList.remove('active');
                                modalOverlay.classList.remove('active');
                                saveSettings();
                            } else {
                                wsAuthenticated = false;
                                document.getElementById('ws-status').textContent = '密码错误';
                                document.getElementById('ws-status').style.color = '#f44336';
                                showToast('密码错误');
                            }
                            return;
                        }
                        
                        // 处理其他类型的消息
                        if (msgObj.type === 'error') {
                            console.error('[sf插件] 服务器错误:', msgObj.content);
                            showToast('服务器错误: ' + msgObj.content);
                        } else if (msgObj.type === 'history') {
                            console.log('[sf插件] 收到历史记录:', msgObj.messages.length, '条消息');
                            // 处理历史记录
                            const chatContainer = document.querySelector('.chat-container');
                            chatContainer.innerHTML = ''; // 清空现有内容
                            msgObj.messages.forEach(msg => {
                                addMessage(msg.content, msg.role === 'user' ? 'right' : 'left', false);
                            });
                        } else if (typeof msgObj.content === 'string') {
                            const content = String(msgObj.content).trim();
                            if (content) {
                                addMessage(content, 'left', true);
                                console.log('[sf插件] 已接收并显示机器人消息:', content);
                            }
                        }
                    } catch (error) {
                        console.error('[sf插件] 处理消息错误:', error);
                        showToast('处理消息时出错');
                    }
                };
            } catch (error) {
                if (!isAutoConnect) {
                    showToast('连接失败: ' + error.message);
                }
                document.getElementById('ws-status').textContent = '未连接';
                document.getElementById('ws-status').style.color = '#f44336';
            }
        }

        // 注册Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/public/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>

</html>
